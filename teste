"""
AI Chart Generator - Streamlit + Google AI Studio + ECharts
Cria gr√°ficos automaticamente baseado em descri√ß√µes em linguagem natural
"""

import streamlit as st
import json
import os
from streamlit_echarts import st_echarts
import google.generativeai as genai

# Configura√ß√£o da p√°gina
st.set_page_config(
    page_title="AI Chart Generator",
    page_icon="üìä",
    layout="wide"
)

# T√≠tulo
st.title("üìä AI Chart Generator")
st.markdown("**Descreva o gr√°fico que voc√™ quer e a IA cria para voc√™!**")

# Sidebar para configura√ß√£o
with st.sidebar:
    st.header("‚öôÔ∏è Configura√ß√£o")
    
    # API Key do Google AI Studio
    api_key = st.text_input(
        "Google AI Studio API Key",
        type="password",
        help="Cole sua chave de API do Google AI Studio aqui. Obtenha em: https://aistudio.google.com/app/apikey"
    )
    
    if api_key:
        os.environ["GOOGLE_API_KEY"] = api_key
        genai.configure(api_key=api_key)
        st.success("‚úÖ API Key configurada!")
    else:
        st.warning("‚ö†Ô∏è Insira sua API Key para come√ßar")
    
    st.divider()
    
    # Seletor de modelo
    st.subheader("ü§ñ Modelo de IA")
    
    model_options = {
        "Gemini 3 Pro Preview (Mais avan√ßado)": "gemini-3-pro-preview",
        "Gemini 2.5 Pro (Alto desempenho)": "gemini-2.5-pro",
        "Gemini 2.5 Flash (R√°pido e eficiente)": "gemini-2.5-flash",
        "Gemini 2.5 Flash-Lite (Mais r√°pido)": "gemini-2.5-flash-lite"
    }
    
    selected_model = st.selectbox(
        "Selecione o modelo:",
        options=list(model_options.keys()),
        index=2,
        help="Diferentes modelos t√™m diferentes capacidades e velocidades"
    )
    
    model_name = model_options[selected_model]
    
    # Descri√ß√µes dos modelos
    model_descriptions = {
        "gemini-3-pro-preview": "üéØ Modelo mais avan√ßado com racioc√≠nio complexo e compreens√£o multimodal",
        "gemini-2.5-pro": "üî• Alto desempenho para tarefas complexas",
        "gemini-2.5-flash": "‚ö° R√°pido com grande janela de contexto",
        "gemini-2.5-flash-lite": "üöÄ Mais r√°pido e econ√¥mico para tarefas de alto volume"
    }
    
    st.info(model_descriptions[model_name])
    
    st.divider()
    
    st.markdown("""
    ### üí° Exemplos de Prompts
    
    - "Gr√°fico de barras com vendas mensais de 2024"
    - "Gr√°fico de pizza mostrando participa√ß√£o de mercado"
    - "Gr√°fico de linhas com temperatura ao longo do ano"
    - "Gr√°fico de √°rea com receita trimestral"
    - "Gr√°fico de dispers√£o com dados de altura e peso"
    """)

# Sistema de prompts para o Gemini
SYSTEM_PROMPT = """Voc√™ √© um especialista em criar configura√ß√µes de gr√°ficos ECharts.
Sua tarefa √© converter descri√ß√µes em linguagem natural em configura√ß√µes JSON v√°lidas para ECharts.

Regras importantes:
1. Retorne APENAS o JSON, sem explica√ß√µes adicionais
2. Use a estrutura completa do ECharts com todos os componentes necess√°rios
3. Gere dados de exemplo realistas se o usu√°rio n√£o fornecer
4. Use cores atraentes e design moderno
5. Inclua tooltip, legend, grid quando apropriado
6. Para s√©ries num√©ricas, use n√∫meros, n√£o strings
7. Certifique-se de que o JSON seja v√°lido e possa ser parseado

Exemplo de estrutura b√°sica:
{
  "title": {"text": "T√≠tulo do Gr√°fico"},
  "tooltip": {},
  "legend": {"data": ["Series1"]},
  "xAxis": {"type": "category", "data": ["A", "B", "C"]},
  "yAxis": {"type": "value"},
  "series": [{"name": "Series1", "type": "bar", "data": [10, 20, 30]}]
}

Tipos de gr√°ficos suportados: bar, line, pie, scatter, radar, heatmap, gauge, funnel, sankey, treemap, etc.
"""

def generate_chart_config(user_prompt: str, model_name: str = 'gemini-2.5-flash') -> dict:
    """Usa o Gemini para gerar configura√ß√£o do gr√°fico"""
    try:
        model = genai.GenerativeModel(model_name)
        
        full_prompt = f"""{SYSTEM_PROMPT}

Descri√ß√£o do usu√°rio: {user_prompt}

Gere a configura√ß√£o ECharts em JSON:"""
        
        response = model.generate_content(full_prompt)
        
        # Extrair JSON da resposta
        text = response.text.strip()
        
        # Remover markdown code blocks se existirem
        if text.startswith("```json"):
            text = text[7:]
        elif text.startswith("```"):
            text = text[3:]
        
        if text.endswith("```"):
            text = text[:-3]
        
        text = text.strip()
        
        # Parse do JSON
        config = json.loads(text)
        return config
        
    except json.JSONDecodeError as e:
        st.error(f"‚ùå Erro ao processar JSON: {e}")
        st.code(text, language="text")
        return None
    except Exception as e:
        st.error(f"‚ùå Erro ao gerar gr√°fico: {e}")
        return None

# Interface principal
col1, col2 = st.columns([1, 1])

with col1:
    st.subheader("üìù Descri√ß√£o do Gr√°fico")
    
    # Input do usu√°rio
    user_input = st.text_area(
        "Descreva o gr√°fico que voc√™ quer criar:",
        value=st.session_state.get('user_input', ''),
        height=150,
        placeholder="Ex: Crie um gr√°fico de barras mostrando as vendas trimestrais de 2024, com Q1: 15000, Q2: 23000, Q3: 18000, Q4: 27000",
        key="user_input_field"
    )
    
    # Bot√£o para gerar
    generate_button = st.button("üöÄ Gerar Gr√°fico", type="primary", use_container_width=True)
    
    # Exemplos r√°pidos com dados fict√≠cios
    st.markdown("**üìã Exemplos r√°pidos com dados:**")
    
    examples = {
        "üìä Barras - Vendas": """Gr√°fico de barras vertical mostrando vendas trimestrais 2024:
Q1: R$ 145.000, Q2: R$ 198.000, Q3: R$ 167.000, Q4: R$ 210.000
Use cores vibrantes e mostre valores nas barras""",
        
        "ü•ß Pizza - Market Share": """Gr√°fico de pizza 3D com participa√ß√£o de mercado de smartphones:
Samsung 28%, Apple 27%, Xiaomi 18%, Oppo 12%, Outros 15%
Use cores diferentes para cada marca""",
        
        "üìà Linhas - Temperatura": """Gr√°fico de linhas com temperatura m√©dia mensal em S√£o Paulo 2024:
Jan: 25¬∞C, Fev: 26¬∞C, Mar: 24¬∞C, Abr: 22¬∞C, Mai: 19¬∞C, Jun: 17¬∞C,
Jul: 17¬∞C, Ago: 19¬∞C, Set: 21¬∞C, Out: 23¬∞C, Nov: 24¬∞C, Dez: 25¬∞C
Com √°rea preenchida sob a linha""",
        
        "üìä Barras Empilhadas": """Gr√°fico de barras empilhadas horizontal mostrando receita por categoria e trimestre 2024:
Q1 - E-commerce: 80k, Lojas: 60k, Atacado: 50k
Q2 - E-commerce: 95k, Lojas: 70k, Atacado: 55k
Q3 - E-commerce: 110k, Lojas: 65k, Atacado: 48k
Q4 - E-commerce: 130k, Lojas: 85k, Atacado: 62k""",
        
        "üìâ √Årea Empilhada": """Gr√°fico de √°rea empilhada mostrando uso de energia por fonte ao longo de 2024:
Jan-Dez com Solar (15-45 MW), E√≥lica (30-80 MW), Hidrel√©trica (100-120 MW)
Use gradientes suaves""",
        
        "üéØ Dispers√£o": """Gr√°fico de dispers√£o mostrando rela√ß√£o altura x peso de 50 pessoas:
Altura entre 150-190 cm, Peso entre 50-100 kg
Adicione linha de tend√™ncia""",
        
        "üé® Radar": """Gr√°fico radar comparando 3 smartphones (iPhone 15, Galaxy S24, Pixel 8):
Categorias: Bateria (0-100), C√¢mera (0-100), Performance (0-100), 
Tela (0-100), Design (0-100), Pre√ßo-Benef√≠cio (0-100)
iPhone: 85, 95, 98, 90, 95, 70
Galaxy: 90, 92, 95, 95, 88, 80
Pixel: 82, 90, 88, 92, 85, 95""",
        
        "üî• Heatmap": """Gr√°fico heatmap mostrando tr√°fego do site por hora e dia da semana:
Segunda a Domingo (linhas) vs 0h-23h (colunas)
Segunda: pico entre 9h-18h
Fim de semana: pico entre 10h-22h
Use escala de cores do azul ao vermelho""",
        
        "‚è±Ô∏è Gauge": """Gr√°fico gauge (veloc√≠metro) mostrando taxa de satisfa√ß√£o do cliente:
Valor atual: 87% 
Escala 0-100%
Verde: 80-100, Amarelo: 60-79, Vermelho: 0-59""",
        
        "üìä Funil": """Gr√°fico funil de convers√£o de vendas:
Visitantes: 10.000
Cadastros: 3.500
Carrinho: 1.200
Compra: 450
P√≥s-venda: 380
Mostre porcentagem de convers√£o""",
        
        "üå≥ Treemap": """Gr√°fico treemap mostrando distribui√ß√£o de despesas mensais:
Moradia (40%): Aluguel 2500, Condom√≠nio 400, IPTU 150
Alimenta√ß√£o (25%): Supermercado 800, Restaurantes 500
Transporte (15%): Combust√≠vel 400, Manuten√ß√£o 200
Lazer (10%): Cinema 100, Streaming 150
Outros (10%): 500
Use cores diferentes por categoria""",
        
        "üìÖ Calend√°rio": """Gr√°fico calend√°rio (heatmap) mostrando commits do GitHub em 2024:
365 dias com valores entre 0-20 commits por dia
Mais ativo em dias √∫teis, menos em finais de semana
Use gradiente verde do GitHub""",
        
        "üï∏Ô∏è Sankey": """Diagrama Sankey mostrando fluxo de energia em uma casa:
Entrada: Rede El√©trica (1000 kWh)
Distribui√ß√£o: Climatiza√ß√£o (400), Ilumina√ß√£o (200), Eletr√¥nicos (250), Cozinha (150)
Use cores diferentes para cada fluxo""",
        
        "üéá Sunburst": """Gr√°fico sunburst mostrando estrutura de vendas:
Total Vendas > [Regi√£o Norte (30%), Sul (25%), Sudeste (45%)]
Cada regi√£o dividida em: Online (60%) e F√≠sica (40%)
Use cores hier√°rquicas""",
        
        "üîµ Bolhas": """Gr√°fico de bolhas mostrando pa√≠ses por PIB, Popula√ß√£o e Continente:
5 pa√≠ses com: Eixo X (PIB), Eixo Y (Popula√ß√£o), Tamanho (√Årea territorial)
Use cores por continente""",
    }
    
    # Organizar em grid de 3 colunas
    example_keys = list(examples.keys())
    num_cols = 3
    num_rows = (len(example_keys) + num_cols - 1) // num_cols
    
    for row in range(num_rows):
        cols = st.columns(num_cols)
        for col_idx in range(num_cols):
            idx = row * num_cols + col_idx
            if idx < len(example_keys):
                key = example_keys[idx]
                with cols[col_idx]:
                    if st.button(key, use_container_width=True, key=f"btn_{idx}"):
                        st.session_state['user_input'] = examples[key]
                        st.rerun()

with col2:
    st.subheader("üìä Gr√°fico Gerado")
    
    chart_placeholder = st.empty()

# Processamento
if generate_button and user_input:
    if not api_key:
        st.error("‚ö†Ô∏è Por favor, configure sua API Key do Google AI Studio na barra lateral!")
    else:
        with st.spinner("ü§ñ IA gerando o gr√°fico..."):
            config = generate_chart_config(user_input, model_name)
            
            if config:
                # Salvar no session state
                st.session_state['chart_config'] = config
                st.session_state['user_prompt'] = user_input
                st.success("‚úÖ Gr√°fico gerado com sucesso!")
                
# Limpar campo de entrada se necess√°rio
if 'user_input' in st.session_state and st.session_state.get('user_input') != st.session_state.get('user_input_field', ''):
    if st.session_state.get('user_input_field', ''):
        st.session_state['user_input'] = st.session_state['user_input_field']

# Exibir gr√°fico se existir no session state
if 'chart_config' in st.session_state:
    with chart_placeholder.container():
        st_echarts(
            options=st.session_state['chart_config'],
            height="500px",
            key="ai_chart"
        )
    
    # Mostrar a configura√ß√£o JSON em um expander
    with st.expander("üîç Ver Configura√ß√£o JSON"):
        st.json(st.session_state['chart_config'])
        
        # Bot√£o para copiar JSON
        json_str = json.dumps(st.session_state['chart_config'], indent=2, ensure_ascii=False)
        st.code(json_str, language="json")
        
    # Op√ß√£o de editar manualmente
    with st.expander("‚úèÔ∏è Editar Configura√ß√£o Manualmente"):
        edited_config = st.text_area(
            "Edite o JSON abaixo:",
            value=json.dumps(st.session_state['chart_config'], indent=2, ensure_ascii=False),
            height=300
        )
        
        if st.button("üîÑ Atualizar Gr√°fico"):
            try:
                new_config = json.loads(edited_config)
                st.session_state['chart_config'] = new_config
                st.success("‚úÖ Gr√°fico atualizado!")
                st.rerun()
            except json.JSONDecodeError as e:
                st.error(f"‚ùå JSON inv√°lido: {e}")

else:
    with chart_placeholder.container():
        st.info("üëÜ Descreva o gr√°fico que voc√™ quer e clique em 'Gerar Gr√°fico'")

# Footer
st.divider()
st.markdown("""
<div style='text-align: center; color: #666; padding: 20px;'>
    <p>üöÄ Powered by <strong>Google AI Studio (Gemini)</strong> + <strong>Streamlit</strong> + <strong>Apache ECharts</strong></p>
    <p>üí° Obtenha sua API Key em: <a href='https://aistudio.google.com/app/apikey' target='_blank'>Google AI Studio</a></p>
</div>
""", unsafe_allow_html=True)
